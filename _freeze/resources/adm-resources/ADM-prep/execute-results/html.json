{
  "hash": "7e3f8939abf7f4aed5972a4307f36a7e",
  "result": {
    "markdown": "---\ntitle: \"ADM-Data-Prep\"\nexecute: \n  eval: false\n  echo: true\n---\n\n\n## Purpose\n\nIngest and collect together the data from [here](https://ec.europa.eu/eurostat/cache/RCI/#?vis=nuts2.scitech&lang=en)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\nPrep: these are the years for each series.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nseries_dates <- tribble(\n  ~category, ~early, ~late,\n  \"economy\", 2012, 2020,\n  \"population\", 2011, 2020,\n  \"health\", 2011, 2019,\n  \"education\", 2013, 2021,\n  \"labour_market\", 2012, 2021,\n  \"tourism\", 2013, 2020,\n  \"digital_economy_and_society\", 2012, 2021,\n  \"agriculture\", 2012, 2021,\n  \"transport\", 2012, 2020,\n  \"science_and_technology\", 2011, 2020\n)\n\nseries_dates <- series_dates %>% \n  pivot_longer(-category, values_to = \"year\") %>% \n  mutate(sheet = str_c(category, \"_\", name)) %>% \n  select(sheet, year)\n```\n:::\n\n\nFunction to get data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_data <- function(f_name, sheet_name) {\n  message(\"Getting data from \", f_name)\n  \n  df <- readxl::read_excel(f_name)\n  \n  df %>%\n    select(-sortOrder) %>%\n    pivot_longer(-c(\"Region\", \"Code\", \"Country\"), names_to = \"indicator\") %>%\n    mutate(\n      # remove brackets\n      value = str_remove(value, \"\\\\(.*\"),\n      # remove spaces\n      value = str_remove_all(value, \" \"),\n    ) %>%\n    mutate(value = case_when(\n      # replace pct sign\n      str_detect(value, \"%\") ~ parse_number(value) / 100,\n      # otherwise go numeric\n      TRUE ~ as.numeric(value)\n    )) %>% \n    mutate(stat_domain = sheet_name)\n}\n```\n:::\n\n\nGet files in this chunk.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlist_of_files <- list.files(here::here(\"resources\", \"adm-resources\"), pattern = \".xlsx\")\n\ntbl_of_files <- list_of_files %>% \n  as_tibble() %>% \n  mutate(file_path = here::here(\"resources/adm-resources/\", value),\n         value = str_remove(value, \"\\\\.xlsx\")) %>% \n  rename(sheet = value)\n\ntbl_of_files <- tbl_of_files %>% \n  mutate(data = pmap(list(file_path, sheet), get_data))\n\ntbl_of_files <- tbl_of_files %>% \n  inner_join(series_dates)\n\ndf <- tbl_of_files %>% \n  unnest(data)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df %>%\n  select(-c(sheet, file_path)) %>%\n  mutate(\n    period = str_extract(stat_domain, \"early|late\"),\n    stat_domain = str_replace_all(stat_domain, \"_\", \" \"),\n    stat_domain = str_remove(stat_domain, \"early|late\"),\n    stat_domain = str_to_title(stat_domain),\n    stat_domain = str_squish(stat_domain),\n    indicator = str_squish(indicator)\n  ) %>%\n  janitor::clean_names() \n\n# series_to_distinct <- c(\n#   \"Population (persons)\",\n#   \"Population density (persons per square kilometre)\",\n#   \"Employment rate (% of population aged 20-64)\",\n#   \"Unemployment rate (% of labour force aged 15-74)\",\n#   \"Gross domestic product (PPS per inhabitant)\",\n#   \"Gross domestic product (PPS per inhabitant in % of the EU-27 average)\"\n# )\n\n\n# df_to_join <- df %>% \n#   filter(indicator %in% series_to_distinct) %>% \n#   distinct(region, code, country, indicator, .keep_all = T)\n\n# df <- df %>% \n#   filter(!indicator %in% series_to_distinct) %>% \n#   bind_rows(df_to_join)\n\ndf <- df %>% \n  arrange(code, stat_domain, indicator, period)\n\n\n\ndf %>% write_rds(here::here(\"resources/adm-resources/regions_illustrated.rds\"), compress = \"gz\")\ndf %>% \n  write_excel_csv(here::here(\"resources/adm-resources/regions_illustrated.csv\"))\n```\n:::\n",
    "supporting": [
      "ADM-prep_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}